<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿„ç½—æ–¯æ–¹å— - è¶£å‘³å°æ¸¸æˆ</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1>ğŸ§© ä¿„ç½—æ–¯æ–¹å—</h1>
        <p>ä½¿ç”¨æ–¹å‘é”®æ§åˆ¶æ–¹å—ï¼Œæ¶ˆé™¤å®Œæ•´è¡Œè·å¾—åˆ†æ•°ï¼</p>
    </header>

    <main>
        <div class="game-container">
            <div class="game-header">
                <a href="index.html" class="back-btn">â† è¿”å›ä¸»é¡µ</a>
                <div class="score">åˆ†æ•°: <span id="score">0</span></div>
                <div class="score">ç­‰çº§: <span id="level">1</span></div>
                <div class="score">è¡Œæ•°: <span id="lines">0</span></div>
            </div>
            
            <div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap;">
                <div>
                    <canvas id="gameCanvas" class="game-canvas" width="300" height="600"></canvas>
                </div>
                <div style="text-align: center;">
                    <h3>ä¸‹ä¸€ä¸ªæ–¹å—</h3>
                    <canvas id="nextCanvas" class="game-canvas" width="120" height="120" style="margin-bottom: 1rem;"></canvas>
                    <div class="score">æœ€é«˜åˆ†: <span id="high-score">0</span></div>
                </div>
            </div>
            
            <div class="game-controls">
                <button id="startBtn" class="control-btn">å¼€å§‹æ¸¸æˆ</button>
                <button id="pauseBtn" class="control-btn" disabled>æš‚åœ</button>
                <button id="resetBtn" class="control-btn">é‡æ–°å¼€å§‹</button>
            </div>
            
            <div style="margin-top: 1rem; text-align: center; color: #666;">
                <p>â† â†’ ç§»åŠ¨æ–¹å—ï¼Œâ†“ åŠ é€Ÿä¸‹é™ï¼Œâ†‘ æ—‹è½¬æ–¹å—</p>
                <p>æˆ–ä½¿ç”¨ A D S W é”®æ§åˆ¶</p>
                <p id="current-time" style="margin-top: 0.5rem; font-size: 0.9rem;"></p>
            </div>
        </div>
    </main>

    <script src="main.js"></script>
    <script>
        /**
         * ä¿„ç½—æ–¯æ–¹å—æ¸¸æˆç±»
         */
        class TetrisGame {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.nextCanvas = document.getElementById('nextCanvas');
                this.nextCtx = this.nextCanvas.getContext('2d');
                
                this.blockSize = 30;
                this.boardWidth = 10;
                this.boardHeight = 20;
                
                this.board = [];
                this.currentPiece = null;
                this.nextPiece = null;
                this.score = 0;
                this.level = 1;
                this.lines = 0;
                this.highScore = Utils.storage.get('tetris-high-score', 0);
                this.gameRunning = false;
                this.gamePaused = false;
                this.dropTime = 0;
                this.dropInterval = 1000;
                
                this.pieces = [
                    // I å½¢çŠ¶
                    [[[1,1,1,1]]],
                    // O å½¢çŠ¶
                    [[[1,1],[1,1]]],
                    // T å½¢çŠ¶
                    [[[0,1,0],[1,1,1]], [[1,0],[1,1],[1,0]], [[1,1,1],[0,1,0]], [[0,1],[1,1],[0,1]]],
                    // S å½¢çŠ¶
                    [[[0,1,1],[1,1,0]], [[1,0],[1,1],[0,1]]],
                    // Z å½¢çŠ¶
                    [[[1,1,0],[0,1,1]], [[0,1],[1,1],[1,0]]],
                    // J å½¢çŠ¶
                    [[[1,0,0],[1,1,1]], [[1,1],[1,0],[1,0]], [[1,1,1],[0,0,1]], [[0,1],[0,1],[1,1]]],
                    // L å½¢çŠ¶
                    [[[0,0,1],[1,1,1]], [[1,0],[1,0],[1,1]], [[1,1,1],[1,0,0]], [[1,1],[0,1],[0,1]]]
                ];
                
                this.colors = [
                    '#00f5ff', // I - é’è‰²
                    '#ffff00', // O - é»„è‰²
                    '#800080', // T - ç´«è‰²
                    '#00ff00', // S - ç»¿è‰²
                    '#ff0000', // Z - çº¢è‰²
                    '#0000ff', // J - è“è‰²
                    '#ffa500'  // L - æ©™è‰²
                ];
                
                this.init();
            }
            
            /**
             * åˆå§‹åŒ–æ¸¸æˆ
             */
            init() {
                this.initBoard();
                this.updateDisplay();
                this.setupEventListeners();
                this.draw();
            }
            
            /**
             * åˆå§‹åŒ–æ¸¸æˆæ¿
             */
            initBoard() {
                this.board = [];
                for (let y = 0; y < this.boardHeight; y++) {
                    this.board[y] = [];
                    for (let x = 0; x < this.boardWidth; x++) {
                        this.board[y][x] = 0;
                    }
                }
            }
            
            /**
             * è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
             */
            setupEventListeners() {
                document.addEventListener('keydown', (e) => this.handleKeyPress(e));
                
                document.getElementById('startBtn').addEventListener('click', () => this.startGame());
                document.getElementById('pauseBtn').addEventListener('click', () => this.togglePause());
                document.getElementById('resetBtn').addEventListener('click', () => this.resetGame());
            }
            
            /**
             * å¤„ç†é”®ç›˜æŒ‰é”®
             * @param {KeyboardEvent} e - é”®ç›˜äº‹ä»¶
             */
            handleKeyPress(e) {
                if (!this.gameRunning || this.gamePaused) return;
                
                const key = e.key.toLowerCase();
                
                switch (key) {
                    case 'arrowleft':
                    case 'a':
                        this.movePiece(-1, 0);
                        break;
                    case 'arrowright':
                    case 'd':
                        this.movePiece(1, 0);
                        break;
                    case 'arrowdown':
                    case 's':
                        this.movePiece(0, 1);
                        break;
                    case 'arrowup':
                    case 'w':
                        this.rotatePiece();
                        break;
                }
            }
            
            /**
             * å¼€å§‹æ¸¸æˆ
             */
            startGame() {
                if (!this.gameRunning) {
                    this.gameRunning = true;
                    this.gamePaused = false;
                    this.spawnPiece();
                    this.gameLoop();
                    
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('pauseBtn').disabled = false;
                }
            }
            
            /**
             * åˆ‡æ¢æš‚åœçŠ¶æ€
             */
            togglePause() {
                if (this.gameRunning) {
                    this.gamePaused = !this.gamePaused;
                    document.getElementById('pauseBtn').textContent = this.gamePaused ? 'ç»§ç»­' : 'æš‚åœ';
                    
                    if (!this.gamePaused) {
                        this.gameLoop();
                    }
                }
            }
            
            /**
             * é‡ç½®æ¸¸æˆ
             */
            resetGame() {
                this.gameRunning = false;
                this.gamePaused = false;
                this.score = 0;
                this.level = 1;
                this.lines = 0;
                this.dropInterval = 1000;
                this.currentPiece = null;
                this.nextPiece = null;
                this.initBoard();
                this.updateDisplay();
                this.draw();
                
                document.getElementById('startBtn').disabled = false;
                document.getElementById('pauseBtn').disabled = true;
                document.getElementById('pauseBtn').textContent = 'æš‚åœ';
            }
            
            /**
             * æ¸¸æˆä¸»å¾ªç¯
             */
            gameLoop() {
                if (!this.gameRunning || this.gamePaused) return;
                
                const now = Date.now();
                if (now - this.dropTime > this.dropInterval) {
                    this.dropPiece();
                    this.dropTime = now;
                }
                
                this.draw();
                requestAnimationFrame(() => this.gameLoop());
            }
            
            /**
             * ç”Ÿæˆæ–°æ–¹å—
             */
            spawnPiece() {
                if (!this.nextPiece) {
                    this.nextPiece = this.createRandomPiece();
                }
                
                this.currentPiece = this.nextPiece;
                this.nextPiece = this.createRandomPiece();
                
                this.currentPiece.x = Math.floor(this.boardWidth / 2) - Math.floor(this.currentPiece.shape[0].length / 2);
                this.currentPiece.y = 0;
                
                if (this.checkCollision(this.currentPiece, 0, 0)) {
                    this.gameOver();
                }
                
                this.drawNext();
            }
            
            /**
             * åˆ›å»ºéšæœºæ–¹å—
             * @returns {Object} æ–¹å—å¯¹è±¡
             */
            createRandomPiece() {
                const typeIndex = Math.floor(Math.random() * this.pieces.length);
                const rotationIndex = Math.floor(Math.random() * this.pieces[typeIndex].length);
                
                return {
                    shape: this.pieces[typeIndex][rotationIndex],
                    color: this.colors[typeIndex],
                    type: typeIndex,
                    rotation: rotationIndex,
                    x: 0,
                    y: 0
                };
            }
            
            /**
             * ç§»åŠ¨æ–¹å—
             * @param {number} dx - Xæ–¹å‘åç§»
             * @param {number} dy - Yæ–¹å‘åç§»
             */
            movePiece(dx, dy) {
                if (!this.currentPiece) return;
                
                if (!this.checkCollision(this.currentPiece, dx, dy)) {
                    this.currentPiece.x += dx;
                    this.currentPiece.y += dy;
                }
            }
            
            /**
             * æ—‹è½¬æ–¹å—
             */
            rotatePiece() {
                if (!this.currentPiece) return;
                
                const nextRotation = (this.currentPiece.rotation + 1) % this.pieces[this.currentPiece.type].length;
                const rotatedShape = this.pieces[this.currentPiece.type][nextRotation];
                
                const tempPiece = {
                    ...this.currentPiece,
                    shape: rotatedShape,
                    rotation: nextRotation
                };
                
                if (!this.checkCollision(tempPiece, 0, 0)) {
                    this.currentPiece.shape = rotatedShape;
                    this.currentPiece.rotation = nextRotation;
                }
            }
            
            /**
             * æ–¹å—ä¸‹é™
             */
            dropPiece() {
                if (!this.currentPiece) return;
                
                if (!this.checkCollision(this.currentPiece, 0, 1)) {
                    this.currentPiece.y++;
                } else {
                    this.placePiece();
                    this.clearLines();
                    this.spawnPiece();
                }
            }
            
            /**
             * æ£€æŸ¥ç¢°æ’
             * @param {Object} piece - æ–¹å—å¯¹è±¡
             * @param {number} dx - Xæ–¹å‘åç§»
             * @param {number} dy - Yæ–¹å‘åç§»
             * @returns {boolean} æ˜¯å¦å‘ç”Ÿç¢°æ’
             */
            checkCollision(piece, dx, dy) {
                const newX = piece.x + dx;
                const newY = piece.y + dy;
                
                for (let y = 0; y < piece.shape.length; y++) {
                    for (let x = 0; x < piece.shape[y].length; x++) {
                        if (piece.shape[y][x]) {
                            const boardX = newX + x;
                            const boardY = newY + y;
                            
                            if (boardX < 0 || boardX >= this.boardWidth || 
                                boardY >= this.boardHeight || 
                                (boardY >= 0 && this.board[boardY][boardX])) {
                                return true;
                            }
                        }
                    }
                }
                
                return false;
            }
            
            /**
             * æ”¾ç½®æ–¹å—åˆ°æ¸¸æˆæ¿
             */
            placePiece() {
                if (!this.currentPiece) return;
                
                for (let y = 0; y < this.currentPiece.shape.length; y++) {
                    for (let x = 0; x < this.currentPiece.shape[y].length; x++) {
                        if (this.currentPiece.shape[y][x]) {
                            const boardX = this.currentPiece.x + x;
                            const boardY = this.currentPiece.y + y;
                            
                            if (boardY >= 0) {
                                this.board[boardY][boardX] = this.currentPiece.color;
                            }
                        }
                    }
                }
            }
            
            /**
             * æ¸…é™¤å®Œæ•´è¡Œ
             */
            clearLines() {
                let linesCleared = 0;
                
                for (let y = this.boardHeight - 1; y >= 0; y--) {
                    if (this.board[y].every(cell => cell !== 0)) {
                        this.board.splice(y, 1);
                        this.board.unshift(new Array(this.boardWidth).fill(0));
                        linesCleared++;
                        y++; // é‡æ–°æ£€æŸ¥è¿™ä¸€è¡Œ
                    }
                }
                
                if (linesCleared > 0) {
                    this.lines += linesCleared;
                    this.score += linesCleared * 100 * this.level;
                    this.level = Math.floor(this.lines / 10) + 1;
                    this.dropInterval = Math.max(100, 1000 - (this.level - 1) * 100);
                    this.updateDisplay();
                }
            }
            
            /**
             * ç»˜åˆ¶æ¸¸æˆç”»é¢
             */
            draw() {
                // æ¸…ç©ºç”»å¸ƒ
                this.ctx.fillStyle = '#f8f9fa';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // ç»˜åˆ¶æ¸¸æˆæ¿
                for (let y = 0; y < this.boardHeight; y++) {
                    for (let x = 0; x < this.boardWidth; x++) {
                        if (this.board[y][x]) {
                            this.ctx.fillStyle = this.board[y][x];
                            this.ctx.fillRect(x * this.blockSize, y * this.blockSize, this.blockSize - 1, this.blockSize - 1);
                        }
                    }
                }
                
                // ç»˜åˆ¶å½“å‰æ–¹å—
                if (this.currentPiece) {
                    this.ctx.fillStyle = this.currentPiece.color;
                    for (let y = 0; y < this.currentPiece.shape.length; y++) {
                        for (let x = 0; x < this.currentPiece.shape[y].length; x++) {
                            if (this.currentPiece.shape[y][x]) {
                                const drawX = (this.currentPiece.x + x) * this.blockSize;
                                const drawY = (this.currentPiece.y + y) * this.blockSize;
                                this.ctx.fillRect(drawX, drawY, this.blockSize - 1, this.blockSize - 1);
                            }
                        }
                    }
                }
                
                // ç»˜åˆ¶ç½‘æ ¼çº¿
                this.ctx.strokeStyle = '#ddd';
                this.ctx.lineWidth = 1;
                for (let x = 0; x <= this.boardWidth; x++) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(x * this.blockSize, 0);
                    this.ctx.lineTo(x * this.blockSize, this.canvas.height);
                    this.ctx.stroke();
                }
                for (let y = 0; y <= this.boardHeight; y++) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, y * this.blockSize);
                    this.ctx.lineTo(this.canvas.width, y * this.blockSize);
                    this.ctx.stroke();
                }
            }
            
            /**
             * ç»˜åˆ¶ä¸‹ä¸€ä¸ªæ–¹å—
             */
            drawNext() {
                if (!this.nextPiece) return;
                
                this.nextCtx.fillStyle = '#f8f9fa';
                this.nextCtx.fillRect(0, 0, this.nextCanvas.width, this.nextCanvas.height);
                
                this.nextCtx.fillStyle = this.nextPiece.color;
                const blockSize = 20;
                const offsetX = (this.nextCanvas.width - this.nextPiece.shape[0].length * blockSize) / 2;
                const offsetY = (this.nextCanvas.height - this.nextPiece.shape.length * blockSize) / 2;
                
                for (let y = 0; y < this.nextPiece.shape.length; y++) {
                    for (let x = 0; x < this.nextPiece.shape[y].length; x++) {
                        if (this.nextPiece.shape[y][x]) {
                            this.nextCtx.fillRect(
                                offsetX + x * blockSize,
                                offsetY + y * blockSize,
                                blockSize - 1,
                                blockSize - 1
                            );
                        }
                    }
                }
            }
            
            /**
             * æ›´æ–°æ˜¾ç¤ºä¿¡æ¯
             */
            updateDisplay() {
                document.getElementById('score').textContent = this.score;
                document.getElementById('level').textContent = this.level;
                document.getElementById('lines').textContent = this.lines;
                document.getElementById('high-score').textContent = this.highScore;
                
                if (this.score > this.highScore) {
                    this.highScore = this.score;
                    Utils.storage.set('tetris-high-score', this.highScore);
                    document.getElementById('high-score').textContent = this.highScore;
                }
            }
            
            /**
             * æ¸¸æˆç»“æŸ
             */
            gameOver() {
                this.gameRunning = false;
                alert(`æ¸¸æˆç»“æŸï¼\næœ€ç»ˆåˆ†æ•°: ${this.score}\næ¶ˆé™¤è¡Œæ•°: ${this.lines}\næœ€é«˜åˆ†: ${this.highScore}`);
                this.resetGame();
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ¸¸æˆ
        document.addEventListener('DOMContentLoaded', function() {
            new TetrisGame();
        });
    </script>
</body>
</html>